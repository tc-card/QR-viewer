<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TC Cards QR Scanner</title>

  <!-- Dependencies -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
      background: #f5f5f5;
    }
    #reader {
      width: 100%;
      margin: 20px auto;
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #status {
      padding: 12px;
      margin: 15px 0;
      border-radius: 8px;
      font-weight: bold;
    }
    .scanning { background: #e3f2fd; color: #1565c0; }
    .success  { background: #e8f5e9; color: #2e7d32; }
    .error    { background: #ffebee; color: #c62828; }

    .scanner-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 2;
    }
    .scan-box {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 70%; height: 70%;
      border: 3px solid #4CAF50;
      border-radius: 8px;
      box-shadow: 0 0 0 100vh rgba(0,0,0,0.5);
    }
    .scan-line {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 4px;
      background: #4CAF50;
      animation: scan 2.5s infinite linear;
      box-shadow: 0 0 10px #4CAF50;
    }
    @keyframes scan {
      0% { top: 0; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    #debug {
      text-align: left;
      font-family: monospace;
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #qr-canvas {
      display: none;
    }
  </style>
</head>
<body>
  <h1>TC Cards QR Scanner</h1>
  <p>Align QR code within the frame</p>

  <div id="reader">
    <div class="scanner-overlay">
      <div class="scan-box">
        <div class="scan-line"></div>
      </div>
    </div>
  </div>

  <div id="status" class="scanning">Initializing camera...</div>
  <div id="debug"></div>
  <canvas id="qr-canvas"></canvas>

  <script>
    function debugLog(message) {
      const debugDiv = document.getElementById('debug');
      debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
      console.log(message);
    }

    function updateStatus(message, type = 'scanning') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      debugLog(`STATUS: ${message}`);
    }

    function processScannedText(text) {
      debugLog(`RAW SCAN: "${text}"`);
      text = text.trim().replace(/^['"]?(.*?)['"]?$/, '$1');
      const tcCardsPattern = /^((https?:\/\/)?card\.tccards\.tn\/@id_[a-zA-Z0-9-]{36})$/;

      if (!tcCardsPattern.test(text)) {
        debugLog("INVALID FORMAT - Doesn't match TC Cards pattern");
        return null;
      }

      const url = text.startsWith('http') ? text : `https://${text.replace(/^\/\//, '')}`;
      debugLog(`FORMATTED URL: ${url}`);
      return url;
    }

    async function fallbackScanFromCamera(video) {
      if (!video || video.readyState !== 4) return;

      const canvas = document.getElementById("qr-canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      // Invert pixels
      for (let i = 0; i < imageData.data.length; i += 4) {
        imageData.data[i] = 255 - imageData.data[i];     // R
        imageData.data[i+1] = 255 - imageData.data[i+1]; // G
        imageData.data[i+2] = 255 - imageData.data[i+2]; // B
      }
      ctx.putImageData(imageData, 0, 0);

      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        debugLog(`jsQR fallback decoded: ${code.data}`);
        const url = processScannedText(code.data);
        if (url) {
          updateStatus("Inverted QR detected! Redirecting...", "success");
          setTimeout(() => window.location.href = url, 800);
        } else {
          updateStatus("Inverted QR invalid", "error");
        }
      } else {
        debugLog("Fallback scan: jsQR found no QR code.");
      }
    }

    async function startScanner() {
      debugLog("Initializing scanner...");
      updateStatus("Loading camera...");

      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras.length === 0) throw new Error("No cameras found");

        let selectedCamera = cameras.find(cam => !cam.label.toLowerCase().includes('front')) || cameras[0];
        debugLog(`Selected camera: ${selectedCamera.label}`);

        const html5QrCode = new Html5Qrcode("reader", {
          verbose: true,
          formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
        });

        await html5QrCode.start(
          selectedCamera.id,
          {
            fps: 15,
            qrbox: { width: 250, height: 250 },
            disableFlip: false,
            videoConstraints: {
              width: { ideal: 1920 },
              height: { ideal: 1080 },
              facingMode: "environment",
              deviceId: { exact: selectedCamera.id }
            }
          },
          (decodedText) => {
            const url = processScannedText(decodedText);
            if (url) {
              updateStatus("Valid TC Card detected!", "success");
              document.querySelector('.scan-box').style.borderColor = "#2E7D32";
              document.querySelector('.scan-line').style.background = "#2E7D32";
              setTimeout(() => window.location.href = url, 800);
            } else {
              updateStatus("Invalid QR â€“ trying inverted...", "error");
              document.querySelector('.scan-box').style.borderColor = "#C62828";
              document.querySelector('.scan-line').style.background = "#C62828";

              const video = document.querySelector("video");
              setTimeout(() => fallbackScanFromCamera(video), 1000);

              setTimeout(() => {
                updateStatus("Ready to scan", "scanning");
                document.querySelector('.scan-box').style.borderColor = "#4CAF50";
                document.querySelector('.scan-line').style.background = "#4CAF50";
              }, 3000);
            }
          },
          (err) => {
            debugLog(`html5-qrcode error: ${err}`);
          }
        );

        updateStatus("Ready to scan - align QR code", "scanning");
      } catch (e) {
        debugLog(`ERROR: ${e.message}`);
        updateStatus(`Camera error: ${e.message}`, "error");
      }
    }

    document.addEventListener('DOMContentLoaded', startScanner);
  </script>
</body>
</html>
